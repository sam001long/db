<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Motion Player</title>
  <style>
    :root{--bg:#0b1020;--muted:#9fb0d4}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:#e6eefc;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans TC",sans-serif}
    header{padding:12px 16px;background:#11162a;border-bottom:1px solid #24304f;display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    select,button{background:#091126;color:#e6eefc;border:1px solid #223058;border-radius:10px;padding:8px 10px}
    .muted{color:var(--muted);font-size:12px}
    .wrap{height:calc(100vh - 56px)}
    #c{width:100%;height:100%;display:block}
    #debug{position:fixed;left:12px;bottom:12px;background:#2b0f17;border:1px solid #7a2735;color:#ffd2d2;padding:8px 10px;border-radius:10px;max-width:60ch;display:none;white-space:pre-wrap;z-index:20}
    #bones{position:fixed;right:12px;bottom:12px;background:#0b1329;border:1px solid #1f2a4a;border-radius:12px;max-height:50vh;max-width:42vw;overflow:auto;padding:10px 12px;color:#cfe0ff;font:12px/1.4 system-ui;z-index:10}
    #bones hr{border:0;border-top:1px solid #1f2a4a;margin:6px 0}
    #bones input{width:100%;margin:8px 0 6px;background:#091126;color:#e6eefc;border:1px solid #223058;border-radius:8px;padding:6px 8px}
  </style>
</head>
<body>
  <header>
    <div class="muted">模型：</div>
    <span class="muted">docs/animation/assets/model.glb</span>
    <div style="flex:1"></div>
    <label class="muted">動作：</label>
    <select id="motion"></select>
    <button id="reload">重載清單</button>
  </header>
  <div class="wrap"><canvas id="c"></canvas></div>
  <div id="debug"></div>
  <div id="bones" hidden>
    <b>Skeleton bones</b>
    <input id="boneFilter" placeholder="filter">
    <div id="boneList" style="font-family:ui-monospace,Consolas,monospace"></div>
  </div>

  <script type="module">
    import * as THREE from './vendor/three.module.js';
    import { GLTFLoader } from './vendor/GLTFLoader.js';
    import { OrbitControls } from './vendor/OrbitControls.js';

    const $debug = document.getElementById('debug');
    const err = (msg)=>{ $debug.style.display='block'; $debug.textContent=msg; console.error(msg); };
    const info = (msg)=>{ console.log(msg); };

    // --- 場景 + 控制 ---
    const canvas = document.getElementById('c');
    const renderer = new THREE.WebGLRenderer({canvas, antialias:true});
    const scene = new THREE.Scene(); scene.background = new THREE.Color(0x0b1020);
    const camera = new THREE.PerspectiveCamera(50, 16/9, .1, 100); camera.position.set(0,1.4,2);
    const controls = new OrbitControls(camera, canvas);
    controls.enableDamping = true; controls.dampingFactor = 0.07;
    controls.target.set(0,1.1,0);
    scene.add(new THREE.HemisphereLight(0xffffff,0x222233,1.2));
    const clock = new THREE.Clock();
    let model, mixer;

    function resize(){
      const w=canvas.clientWidth, h=canvas.clientHeight;
      if(canvas.width!==w || canvas.height!==h){
        renderer.setSize(w,h,false); camera.aspect=w/h; camera.updateProjectionMatrix();
      }
    }

    // --- 骨頭面板 ---
    const $bones = document.getElementById('bones');
    const $boneList = document.getElementById('boneList');
    const $boneFilter = document.getElementById('boneFilter');
    const bonePath=(node)=>{ const names=[]; let p=node; while(p){ names.push(p.name||p.type); p=p.parent; } return names.reverse().join(' / '); };
    function renderBones(root){
      const all=[]; root.traverse(o=>{ if(o.isBone){ all.push({name:o.name, path:bonePath(o)}); } });
      $bones.hidden=false;
      const draw=(q='')=>{
        const k=q.trim().toLowerCase();
        const rows=(k?all.filter(x=>x.name.toLowerCase().includes(k)||x.path.toLowerCase().includes(k)):all)
          .map(x=>`<div><b>${x.name}</b><br><span style="color:#8fa3c7">${x.path}</span></div>`).join('<hr>');
        $boneList.innerHTML = rows || '<i style="color:#8fa3c7">no match</i>';
      };
      draw(); $boneFilter.oninput = e=>draw(e.target.value);
    }

    // --- 載模型 ---
    const gltfLoader = new GLTFLoader();
    try{
      const gltf = await gltfLoader.loadAsync('./assets/model.glb');
      model = gltf.scene;
      model.traverse(o=>{ if(o.isMesh){ o.castShadow = true; o.receiveShadow = true; } });
      scene.add(model);
      mixer = new THREE.AnimationMixer(model);
      renderBones(model);
      info('model ok');
    }catch(e){ err('模型載入失敗：'+e.message); }

    // --- 動作清單 & 播放（含淨化） ---
    const sel = document.getElementById('motion');

    function sanitizeClipJson(json){
      const out = { name: json.name || 'clip', tracks: [] };
      const safeNum = (v)=> typeof v === 'number' && Number.isFinite(v);
      for(const t of (json.tracks||[])){
        if(!t || !t.name || !Array.isArray(t.times) || !Array.isArray(t.values)) continue;
        const type = t.type || (t.name.endsWith('.quaternion') ? 'quaternion' : '');
        if(!type) continue;
        const times = t.times.filter(safeNum);
        const values = t.values.filter(safeNum);
        if(!times.length) continue;
        if(type==='quaternion'){
          const n = Math.min(times.length, Math.floor(values.length/4));
          if(n<=0) continue;
          out.tracks.push({ name:t.name, type:'quaternion',
            times: times.slice(0,n),
            values: values.slice(0,n*4)
          });
        } else if(type==='vector'){
          const n = Math.min(times.length, Math.floor(values.length/3));
          if(n<=0) continue;
          out.tracks.push({ name:t.name, type:'vector',
            times: times.slice(0,n),
            values: values.slice(0,n*3)
          });
        } else {
          // 其他型別直接略過，避免 three 解析失敗
          continue;
        }
      }
      return out;
    }

    async function loadMotionList(){
      try{
        const res = await fetch('./motions/index.json', {cache:'no-store'});
        if(!res.ok) throw new Error('HTTP '+res.status);
        const data = await res.json();
        const items = data.items || [];
        sel.innerHTML = items.map(x=>`<option value="${x.file}">${x.label}</option>`).join('');
        return items;
      }catch(e){
        err('讀取 motions/index.json 失敗：'+e.message);
        sel.innerHTML = '';
        return [];
      }
    }

    async function playMotion(file){
      if(!mixer || !file) return;
      try{
        const raw = await fetch('./motions/'+file, {cache:'no-store'}).then(r=>r.json());
        const cleaned = sanitizeClipJson(raw);
        if(!cleaned.tracks.length){
          err('此動作沒有可用的 tracks（可能骨頭名全部對不到或數據為空）');
          return;
        }
        const clip = THREE.AnimationClip.parse(cleaned);
        mixer.stopAllAction();
        mixer.clipAction(clip).reset().setLoop(THREE.LoopRepeat, Infinity).play();
        $debug.style.display='none';
        info(`play ${file}: ${cleaned.tracks.length} tracks`);
      }catch(e){
        err('載入動作檔失敗：'+e.message+'（可能為資料缺軸或骨頭名不相符）');
      }
    }

    sel.addEventListener('change', e=>playMotion(e.target.value));
    document.getElementById('reload').addEventListener('click', async ()=>{
      const items = await loadMotionList();
      if(items[0]) playMotion(items[0].file);
    });

    // --- 迴圈 ---
    (function tick(){ requestAnimationFrame(tick); resize(); controls.update(); if(mixer) mixer.update(clock.getDelta()); renderer.render(scene,camera); })();

    // 初次載入清單並自動播放第一個
    loadMotionList().then(items => { if(items[0]) playMotion(items[0].file); });
  </script>
</body>
</html>
