<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Animation – health check</title>
  <style>
    body{margin:0;background:#0b1020;color:#e6eefc;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans TC",sans-serif}
    header{padding:12px 16px;background:#11162a;border-bottom:1px solid #24304f}
    .muted{color:#9fb0d4}
    #log{padding:14px 16px;line-height:1.6}
    .ok{color:#9fffb2} .bad{color:#ff9f9f}
    #app{height:calc(100vh - 92px)}
    #c{width:100%;height:100%;display:block}
  </style>
</head>
<body>
  <header>
    <div class="muted">docs/animation/index.html</div>
    <div class="muted">這頁會先檢查檔案是否存在 → 全部 OK 才載入 three.js 與播放器</div>
  </header>
  <div id="log"></div>
  <div id="app" hidden>
    <div style="padding:8px 16px">
      模型：<span class="muted">docs/animation/assets/model.glb</span>　
      動作：<select id="motion"></select>
      <button id="reload">重載清單</button>
    </div>
    <canvas id="c"></canvas>
  </div>

  <script type="module">
    const log = document.getElementById('log');
    const say = (html)=> log.insertAdjacentHTML('beforeend', html + '<br>');

    async function exists(url){
      try{
        const r = await fetch(url, {method:'HEAD', cache:'no-store'});
        return r.ok;
      }catch{ return false }
    }

    // 逐項檢查
    const files = {
      three: './vendor/three.module.js',
      loader:'./vendor/GLTFLoader.js',
      util:  './utils/BufferGeometryUtils.js',
      model: './assets/model.glb',
      index: './motions/index.json'
    };

    const results = {};
    for (const [k,u] of Object.entries(files)){
      results[k] = await exists(u);
      say(`${u} → ${results[k] ? '<span class=ok>OK</span>' : '<span class=bad>缺失</span>'}`);
    }

    // 必要條件：three、loader、model 存在；index.json 可稍後再產
    if (!results.three || !results.loader || !results.model){
      say('<br><b class=bad>❌ 以上至少有一個必要檔缺失，播放器不會載入。</b><br>請確認：\
      <br>• vendor/three.module.js、vendor/GLTFLoader.js \
      <br>• assets/model.glb（可用我給的 Xbot/Fox workflow 先放示範檔）\
      <br>• （選配）utils/BufferGeometryUtils.js');
      throw new Error('missing files');
    }

    // 真的載入 three 與 GLTFLoader（ESM）
    say('<br><span class=ok>開始載入播放器…</span>');
    const THREE = await import('./vendor/three.module.js');
    const { GLTFLoader } = await import('./vendor/GLTFLoader.js');

    // --- 以下是精簡播放器（僅為驗證能否跑起來） ---
    const app = document.getElementById('app'); app.hidden = false;
    const canvas = document.getElementById('c');
    const renderer = new THREE.WebGLRenderer({canvas, antialias:true});
    const scene = new THREE.Scene(); scene.background = new THREE.Color(0x0b1020);
    const camera = new THREE.PerspectiveCamera(50, 16/9, .1, 100); camera.position.set(0,1.4,2);
    scene.add(new THREE.HemisphereLight(0xffffff,0x222233,1.2));
    const clock = new THREE.Clock(); let model, mixer;

    function resize(){ const w=canvas.clientWidth, h=canvas.clientHeight;
      if(canvas.width!==w || canvas.height!==h){ renderer.setSize(w,h,false); camera.aspect=w/h; camera.updateProjectionMatrix(); } }

    // 載模型
    const loader = new GLTFLoader();
    try{
      const gltf = await loader.loadAsync('./assets/model.glb');
      model = gltf.scene; scene.add(model); mixer = new THREE.AnimationMixer(model);
      say('<span class=ok>模型載入成功</span>');
    }catch(e){
      say('<span class=bad>模型載入失敗：</span>' + e.message);
      throw e;
    }

    // 動作清單（可沒有）
    let motions = [];
    if (results.index){
      try{
        const data = await (await fetch('./motions/index.json', {cache:'no-store'})).json();
        motions = data.items || [];
        say('motions/index.json：<span class=ok>OK</span>，共有 ' + motions.length + ' 個動作');
      }catch{ say('motions/index.json：<span class=bad>讀取失敗</span>'); }
    }else{
      say('motions/index.json：<span class=bad>尚未產生（先跑 ingest workflow）</span>');
    }

    // 播放第一個（若有）
    async function playMotion(file){
      if(!mixer || !file) return;
      const clipData = await (await fetch('./motions/'+file, {cache:'no-store'})).json();
      const clip = THREE.AnimationClip.parse(clipData);
      mixer.stopAllAction(); mixer.clipAction(clip).reset().setLoop(THREE.LoopRepeat, Infinity).play();
    }
    const sel = document.getElementById('motion');
    sel.innerHTML = motions.map(x=>`<option value="${x.file}">${x.label}</option>`).join('');
    document.getElementById('reload').onclick = async ()=>{
      const data = await (await fetch('./motions/index.json', {cache:'no-store'})).json();
      motions = data.items||[]; sel.innerHTML = motions.map(x=>`<option value="${x.file}">${x.label}</option>`).join('');
      if(motions[0]) playMotion(motions[0].file);
    };
    if(motions[0]) playMotion(motions[0].file);

    (function tick(){ requestAnimationFrame(tick); resize(); if(mixer) mixer.update(clock.getDelta()); renderer.render(scene,camera); })();
  </script>
</body>
</html>
